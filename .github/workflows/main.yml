# contoh github workflow untuk github actions (CI)


name: Running unit test, build docker image, push to docker hub and deploy to EC2

on:
  push:
    branches:
      - 'master'
  pull_request:
    branches:
      - 'master'

jobs:
  

  # test-gopath:
  #   env:
  #     GOPATH: ${{ github.workspace }}
  #     GO111MODULE: off
  #   defaults:
  #     run:
  #       working-directory: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v2
  #     with:
  #       path: ${{ env.GOPATH }}/src/github.com/${{ github.repository }}


  # unit-test:
  #   name: "unit test"
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v2
  #   - name: set up go
  #     uses: actions/setup-go@v2
  #     with:
  #       go-version: 1.17

  #   # - uses: actions/checkout@v2
  #   #   uses: actions/setup-go@v2
  #   #   with:
        
  #   # - name: checkout code into the go module directory
    
  #   # - name: run go mod init
  #   #   run: |
  #   #     cd ..
  #   #     go mod init belee

  #   # - name: run go mod tidy
  #   #   run:
  #   #     go mod tidy

  #   - name: running unit test
  #     run: go test ./... -cover
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17

      
    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_PASSWORD }}

    - name: Build and push
      uses: docker/build-push-action@v2
      with:
        context: .
        push: true
        tags: 2010010700/belee

  # build-push-docker:
  #   name: "build image and push to registry"
  #   runs-on: ubuntu-latest
  #   # needs: unit-test
  #   steps:
  #   - uses: actions/checkout@v2
  #   - name: build docker
  #     run: docker build -t 2010010700/belee:1.0.0 .
  #   - name: login registry docker hub
  #     uses: docker/login-action@v1
  #     with:
  #       username: ${{ secrets.DOCKER_HUB_USERNAME }}
  #       password: ${{ secrets.DOCKER_HUB_PASSWORD }}
  #   - name: push image to registry docker hub
  #     run: docker push 2010010700/belee:1.0.0
  
  # deployment-ec2:
  #   name: "Deploy to ec2 from registry docker hub"
  #   runs-on: ubuntu-latest
  #   needs: build-push-docker
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: configuration SSH
  #       env:
  #         SSH_USER: ${{ secrets.SSH_USERNAME }}
  #         SSH_KEY: ${{ secrets.SSH_KEY }}
  #         SSH_HOST: ${{secrets.SSH_HOST }}
  #       run: |
  #         mkdir -p ~/.ssh/
  #         echo "$SSH_KEY" > ~/.ssh/belee.pem
  #         chmod 400 ~/.ssh/belee.pem
  #         cat >>~/.ssh/config <<END
  #         Host development
  #           HostName $SSH_HOST
  #           User $SSH_USER
  #           IdentifyFile ~/.ssh/belee.pem
  #           StrictHostKeyChecking=no
  #         END
  #     - name: Connect EC2 & Remove All Container & Pull from registry & start
  #       run: ssh development 'docker rm -f $(docker ps -a -q) && docker pull 2010010700/belee:1.0.0 && docker run -d -p 8080:8080'






